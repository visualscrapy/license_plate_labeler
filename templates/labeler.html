<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Labeler</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .message-box {
            display: none;
        }
        .image-container {
            width: 100%;
            height: 55vh; /* Sets a fixed height relative to the viewport height */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-lg */
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensures the image fits within the container without distortion */
            border: 2px solid #e5e7eb; /* border-2 border-gray-200 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading-message" class="text-center text-gray-600 font-semibold text-lg">
        Fetching image list...
    </div>

    <div id="content" class="hidden w-full max-w-5xl h-full flex flex-col justify-between bg-white rounded-xl shadow-lg p-6 md:p-10">
        <div class="flex-grow flex flex-col">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Vehicle Image Labeler</h1>

            <!-- Counts Display -->
            <div class="flex flex-wrap justify-center md:justify-around text-center gap-4 mb-6 text-sm md:text-base">
                <div class="p-3 bg-blue-100 text-blue-800 rounded-lg shadow-inner w-full md:w-auto">
                    <p class="font-semibold">Unlabeled Images</p>
                    <p id="unlabeled-count" class="font-bold text-2xl mt-1">0</p>
                </div>
                <div class="p-3 bg-green-100 text-green-800 rounded-lg shadow-inner w-full md:w-auto">
                    <p class="font-semibold">Valid Images</p>
                    <p id="valid-count" class="font-bold text-2xl mt-1">0</p>
                </div>
                <div class="p-3 bg-red-100 text-red-800 rounded-lg shadow-inner w-full md:w-auto">
                    <p class="font-semibold">Invalid Images</p>
                    <p id="invalid-count" class="font-bold text-2xl mt-1">0</p>
                </div>
                <div class="p-3 bg-yellow-100 text-yellow-800 rounded-lg shadow-inner w-full md:w-auto">
                    <p class="font-semibold">Skipped Images</p>
                    <p id="skipped-count" class="font-bold text-2xl mt-1">0</p>
                </div>
            </div>

            <div id="progress-text" class="text-center text-gray-600 mb-6">
                <span id="current-index-display">0</span> of <span id="total-unlabeled-display">0</span> images processed.
            </div>

            <!-- Main Image and Number Plate Section -->
            <div class="flex flex-col md:flex-row items-center md:items-start justify-center md:gap-8 flex-grow">
                <!-- Left Panel: Vehicle Image -->
                <div class="flex-1 max-w-full mb-4 md:mb-0">
                    <div class="image-container">
                        <img id="vehicle-img" src="" alt="Vehicle Image">
                    </div>
                </div>
                <!-- Right Panel: Number Plate & Label Controls -->
                <div class="flex-shrink-0 w-full max-w-sm p-4 rounded-lg bg-gray-50 shadow-inner flex flex-col items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-center text-gray-700 mb-4">Detected Plate</h3>
                        <div class="w-full flex justify-center mb-4">
                            <img id="numberplate-img" src="" alt="License Plate Crop" class="w-full h-auto rounded-md shadow-sm border-2 border-gray-300">
                        </div>
                    </div>
                    <div class="w-full">
                        <input type="text" id="label-input" placeholder="Enter Label" class="w-full p-3 text-lg rounded-lg outline-none bg-white border border-gray-300 shadow-sm mb-4">
                        <div class="flex gap-4">
                            <button id="update-label-btn" class="p-3 text-lg font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none transition-colors duration-200 flex-1">Update Label</button>
                            <button id="valid-btn" class="p-3 rounded-lg text-white font-medium bg-green-500 hover:bg-green-600 focus:outline-none transition-colors duration-200 shadow-lg transform hover:scale-105 flex-1">Valid (V)</button>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Navigation and Validation Buttons -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 w-full max-w-3xl mx-auto mt-6">
            <button id="previous-btn" class="p-3 rounded-lg text-white font-medium bg-blue-500 hover:bg-blue-600 focus:outline-none transition-colors duration-200 shadow-lg transform hover:scale-105">Previous (P)</button>

            <button id="invalid-btn" class="p-3 rounded-lg text-white font-medium bg-red-500 hover:bg-red-600 focus:outline-none transition-colors duration-200 shadow-lg transform hover:scale-105">Invalid (I)</button>
            <button id="skip-btn" class="p-3 rounded-lg text-white font-medium bg-gray-500 hover:bg-gray-600 focus:outline-none transition-colors duration-200 shadow-lg transform hover:scale-105">Skip (S)</button>
            <button id="next-btn" class="p-3 rounded-lg text-white font-medium bg-blue-500 hover:bg-blue-600 focus:outline-none transition-colors duration-200 shadow-lg transform hover:scale-105">Next (N)</button>
        </div>
    </div>

    <div id="all-completed-message" class="message-box text-center">
        <div class="bg-white rounded-xl shadow-lg p-10 max-w-lg">
            <h2 class="text-4xl font-bold text-green-600 mb-4">ðŸ¥³ All Images Labeled!</h2>
            <p class="text-gray-700 text-lg">You have successfully processed all images in the unlabeled directory.</p>
        </div>
    </div>

<script>
    const loadingDiv = document.getElementById('loading-message');
const contentDiv = document.getElementById('content');
const allCompletedDiv = document.getElementById('all-completed-message');

const unlabeledCountDisplay = document.getElementById('unlabeled-count');
const validCountDisplay = document.getElementById('valid-count');
const invalidCountDisplay = document.getElementById('invalid-count');
const skippedCountDisplay = document.getElementById('skipped-count');

const currentIndexDisplay = document.getElementById('current-index-display');
const totalUnlabeledDisplay = document.getElementById('total-unlabeled-display');

const vehicleImg = document.getElementById('vehicle-img');
const numberplateImg = document.getElementById('numberplate-img');
const labelInput = document.getElementById('label-input');
const updateLabelBtn = document.getElementById('update-label-btn');

let allImages = [];
let currentIndex = 0;

// --- Helper Functions ---
async function fetchCounts() {
    try {
        const response = await fetch('/images/counts');
        const counts = await response.json();
        unlabeledCountDisplay.textContent = counts.unlabeled;
        validCountDisplay.textContent = counts.valid;
        invalidCountDisplay.textContent = counts.invalid;
        skippedCountDisplay.textContent = counts.skipped;
        return counts;
    } catch (error) {
        console.error('Error fetching counts:', error);
        // Optionally display a user-facing error
        return null;
    }
}

function showCompletionMessage() {
    contentDiv.classList.add('hidden');
    allCompletedDiv.style.display = 'block';
}

async function loadImage(index) {
    if (allImages.length === 0) {
        showCompletionMessage();
        return;
    }

    const imagePath = allImages[index];

    // Update progress display
    currentIndexDisplay.textContent = index + 1;

    // Hide UI and show loading
    contentDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
    loadingDiv.textContent = 'Loading images...';

    // Load the vehicle image
    vehicleImg.src = `/images/serve/${imagePath.replace(/\\/g, '/')}`;


    // Load the cropped numberplate image
    numberplateImg.src = `/preview_crop/${imagePath.replace(/\\/g, '/')}`;

    // Set default label
    const filename = imagePath.replace(/\\/g, '/').split('/').pop();
    const baseName = filename.split('.')[0];
    labelInput.value = baseName;

    // Add an event listener to the vehicle image to ensure content is displayed after load
    vehicleImg.onload = () => {
        loadingDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
    };

    // If the image fails to load, handle the error
    vehicleImg.onerror = () => {
        console.error(`Error loading image: ${imagePath}`);
        loadingDiv.textContent = 'Failed to load image. Skipping...';
        // Move to the next image after a short delay
        setTimeout(() => nextImage(), 2000);
    };
}

function nextImage() {
    if (currentIndex < allImages.length - 1) {
        currentIndex++;
        loadImage(currentIndex);
    } else {
        // All images in the list have been processed
        showCompletionMessage();
    }
}

function previousImage() {
    if (currentIndex > 0) {
        currentIndex--;
        loadImage(currentIndex);
    }
}

// --- Action Handlers ---
async function moveImage(action) {
    let label = labelInput.value;
    const currentImage = allImages[currentIndex]; // current filename/path

    const payload = {
        img: currentImage,
        label: label,
    };

    try {
        const response = await fetch(`/images/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const data = await response.json();

        if (data.success) {
            // Always update the image path with the new path returned from the server
            if (data.new_path) {
                allImages[currentIndex] = data.new_path.replace(/\\/g, '/');
            }

            // Update counts
            unlabeledCountDisplay.textContent = data.counts.unlabeled;
            validCountDisplay.textContent = data.counts.valid;
            invalidCountDisplay.textContent = data.counts.invalid;
            skippedCountDisplay.textContent = data.counts.skipped;

            // For label/valid actions, move to next image
            if (action === 'label' || action === 'valid') {
                if (currentIndex < allImages.length - 1) {
                    currentIndex++;
                    loadImage(currentIndex);
                } else {
                    showCompletionMessage();
                }
            } else {
                // For invalid/skip, remove from list
                allImages.splice(currentIndex, 1);
                if (currentIndex >= allImages.length) {
                    currentIndex = Math.max(0, allImages.length - 1);
                }
                if (allImages.length === 0) {
                    showCompletionMessage();
                    return;
                }
                loadImage(currentIndex);
            }
        } else {
            console.error('Failed to move image:', data.error);
        }
    } catch (error) {
        console.error('Network or server error:', error);
    }
}


// --- Initial Load Function ---
async function loadInitialState() {
    loadingDiv.textContent = 'Fetching image counts...';
    const counts = await fetchCounts();
    if (counts) {
        totalUnlabeledDisplay.textContent = counts.unlabeled;
        if (counts.unlabeled === 0) {
            showCompletionMessage();
            return;
        }
    }

    loadingDiv.textContent = 'Fetching image list...';
    try {
        const response = await fetch('/images/all');
        const images = await response.json();
        allImages = images;

        if (allImages.length > 0) {
            totalUnlabeledDisplay.textContent = allImages.length;
            currentIndex = 0;
            loadImage(currentIndex);
        } else {
            showCompletionMessage();
        }
    } catch (error) {
        console.error('Error fetching image list:', error);
        loadingDiv.textContent = 'Failed to load images. Check if the server is running.';
        loadingDiv.classList.remove('hidden');
    }
}

// --- Event Listeners ---
document.getElementById('previous-btn').onclick = () => previousImage();
document.getElementById('valid-btn').onclick = () => moveImage('valid');
document.getElementById('invalid-btn').onclick = () => moveImage('invalid');
document.getElementById('skip-btn').onclick = () => moveImage('skip');
document.getElementById('update-label-btn').onclick = () => moveImage('label');
document.getElementById('next-btn').onclick = () => nextImage();

// Keydown for quick actions
document.addEventListener('keydown', (event) => {
    if (event.altKey) {
        if (event.key === 'p' || event.key === 'P') {
            previousImage();
            event.preventDefault(); // prevent browser print dialog
        } else if (event.key === 'n' || event.key === 'N') {
            nextImage();
        } else if (event.key === 'v' || event.key === 'V') {
            document.getElementById('valid-btn').click();
        } else if (event.key === 'i' || event.key === 'I') {
            document.getElementById('invalid-btn').click();
        } else if (event.key === 's' || event.key === 'S') {
            document.getElementById('skip-btn').click();
        }
    }
});


// Auto-capitalize and filter input
labelInput.addEventListener('input', (event) => {
    const start = labelInput.selectionStart;
    const end = labelInput.selectionEnd;
    labelInput.value = labelInput.value.toUpperCase().replace(/[^A-Z0-9-_]/g, '');
    labelInput.setSelectionRange(start, end);
});

window.onload = loadInitialState;

</script>

</body>
</html>
