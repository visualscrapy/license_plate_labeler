<!DOCTYPE html>
<html lang="en">
<head>
    <title>Vehicle Labeler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f4f8;
            color: #2c3e50;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 95%;
            max-width: 1000px;
            margin: 20px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(44, 62, 80, 0.1);
            padding: 30px;
        }
        h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #34495e;
            text-align: center;
            margin-bottom: 25px;
        }
        .img-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin-bottom: 25px;
        }
        @media (min-width: 768px) {
            .img-row {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
            }
        }

        /* Fixed-size container wrapping image + buttons */
        .fixed-window {
            width: 100%;
            max-width: 700px;
            height: 450px;   /* adjust as needed */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            margin: 0 auto;
        }
        .fixed-window .main-image-holder {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #fafafa;
            border-radius: 8px 8px 0 0;
        }
        .fixed-window .main-image-holder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: block;
        }
        .fixed-window .button-group {
            width: 100%;
            padding: 16px 0 12px 0;
            background: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            flex-shrink: 0;
            border-radius: 0 0 8px 8px;
        }

        .info-panel {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        .license-plate-container label {
            font-size: 1rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 5px;
            display: block;
            text-align: left;
        }
        #numberplate-img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            border: 2px solid #bdc3c7;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background: #eee;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }
        .input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #7f8c8d;
        }
        .input-group #label-btn {
            margin-top: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        #label-input {
            padding: 10px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            font-size: 1rem;
            color: #34495e;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-secondary {
            background-color: #f39c12;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #e67e22;
        }
        .btn-navigation {
            background-color: #95a5a6;
            color: white;
        }
        .btn-navigation:hover {
            background-color: #7f8c8d;
        }
        #loading {
            text-align: center;
            font-style: italic;
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 25px;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Vehicle Labeler</h2>
    <div id="loading">Loading image...</div>
    <div id="content" style="display: none;">
        <div class="img-row">
            <div class="fixed-window">
                <div class="main-image-holder">
                <img id="vehicle-img" src="" alt="Vehicle Image">
            </div>
                <div class="button-group">
                    <button id="previous-btn" class="btn btn-navigation">Previous</button>
                    <button id="invalid-btn" class="btn btn-danger">Invalid</button>
                    <button id="skip-btn" class="btn btn-secondary">Skip</button>
                    <button id="valid-btn" class="btn btn-success">Valid</button>

                    <button id="next-btn" class="btn btn-navigation">Next</button>
                </div>
            </div>
            <div class="info-panel">
                <div class="license-plate-container">
                    <label for="numberplate-img">License Plate:</label>
                    <img id="numberplate-img" src="" alt="License Plate Crop">
                </div>
                <div class="input-group">
                    <label for="label-input">Label:</label>
                    <input type="text" id="label-input" placeholder="Enter license plate number">
                    <button id="label-btn" class="btn btn-primary">Update Label</button>
                </div>
            </div>
        </div>
        <div id="message-box" class="message-box"></div>
    </div>
</div>

<script>
    const vehicleImg = document.getElementById('vehicle-img');
    const numberplateImg = document.getElementById('numberplate-img');
    const labelInput = document.getElementById('label-input');
    const loadingDiv = document.getElementById('loading');
    const contentDiv = document.getElementById('content');
    const messageBox = document.getElementById('message-box');

    let allImages = [];
    let currentIndex = -1;

    // This event listener now correctly handles cursor position
    labelInput.addEventListener('input', (event) => {
        // Save the current cursor position
        const cursorPosition = event.target.selectionStart;

        // Perform the capitalization and filtering
        const originalValue = event.target.value;
        const newValue = originalValue.toUpperCase().replace(/[^A-Z0-9]/g, '');

        // Update the value
        event.target.value = newValue;

        // Restore the cursor position
        // This is necessary because setting the value moves the cursor
        event.target.setSelectionRange(cursorPosition, cursorPosition);
    });

    function showMessage(text) {
        messageBox.textContent = text;
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 3000);
    }

    async function loadImageDetails(filename) {
        if (!filename) {
            loadingDiv.textContent = 'All images processed!';
            contentDiv.style.display = 'none';
            return;
        }

        loadingDiv.textContent = 'Loading...';
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';

        try {
            const response = await fetch(`/images/image-details/${filename}`);
            if (!response.ok) {
                console.error(`Error fetching image details for ${filename}:`, response.statusText);
                loadingDiv.textContent = `Could not load image: ${filename}`;
                return;
            }
            const data = await response.json();

            // Construct the correct URL based on the file's path
            const urlPath = `/${data.img}`;

            vehicleImg.src = urlPath;
            numberplateImg.src = data.cropped_img_url;
            labelInput.value = data.label;

            // Update button states
            document.getElementById('previous-btn').disabled = currentIndex <= 0;
            document.getElementById('next-btn').disabled = currentIndex >= allImages.length - 1;
            document.getElementById('valid-btn').disabled = false;
            document.getElementById('invalid-btn').disabled = false;
            document.getElementById('skip-btn').disabled = false;
            document.getElementById('label-btn').disabled = false;

        } catch (error) {
            console.error('Error loading image details:', error);
            loadingDiv.textContent = 'An error occurred while loading the image.';
            return;
        }

        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
    }

    function moveImage(action) {
        const payload = {
            img: allImages[currentIndex],
            label: labelInput.value
        };

        fetch(`/images/${action}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                showMessage(`Image marked as ${action.toUpperCase()}!`);

                // Update the current item in the list with the new path
                if (data.new_path) {
                    allImages[currentIndex] = data.new_path;
                }

                // Temporarily disable buttons to prevent double-click issues
                document.getElementById('valid-btn').disabled = true;
                document.getElementById('invalid-btn').disabled = true;
                document.getElementById('skip-btn').disabled = true;
                document.getElementById('label-btn').disabled = true;

                // Move to the next image
                if (currentIndex < allImages.length - 1) {
                    navigate('next');
                } else {
                    // If this was the last image, reload the list to show all new files
                    loadInitialImage();
                }
            }
        }).catch(error => {
            console.error('Error during image action:', error);
            showMessage('Failed to complete action.');
        });
    }

    function navigate(direction) {
        if (direction === 'next' && currentIndex < allImages.length - 1) {
            currentIndex++;
            loadImageDetails(allImages[currentIndex]);
        } else if (direction === 'previous' && currentIndex > 0) {
            currentIndex--;
            loadImageDetails(allImages[currentIndex]);
        }
    }

    function loadInitialImage() {
        loadingDiv.textContent = 'Fetching image list...';
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';

        fetch('/images/all')
            .then(response => response.json())
            .then(images => {
                allImages = images;
                if (allImages.length > 0) {
                    currentIndex = 0;
                    loadImageDetails(allImages[currentIndex]);
                } else {
                    loadingDiv.textContent = 'No images found.';
                }
            })
            .catch(error => {
                console.error('Error fetching initial image list:', error);
                loadingDiv.textContent = 'Failed to load images.';
            });
    }

    // Attach event listeners
    document.getElementById('previous-btn').onclick = () => navigate('previous');
    document.getElementById('next-btn').onclick = () => navigate('next');
    document.getElementById('valid-btn').onclick = () => moveImage('valid');
    document.getElementById('invalid-btn').onclick = () => moveImage('invalid');
    document.getElementById('skip-btn').onclick = () => moveImage('skip');
    document.getElementById('label-btn').onclick = () => moveImage('label');

    window.onload = loadInitialImage;
</script>
</body>
</html>
